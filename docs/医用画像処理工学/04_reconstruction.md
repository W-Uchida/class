# 4. 画像再構成

## 1. はじめに

### 1.1 講義の目的と全体像
- **背景説明：**  
  医用画像において、画像再構成は正確な診断や治療計画の立案に不可欠です。特にCTやMRI、各医学検査などの断層画像法では、投影データや周波数領域データから診断可能な画像への再構成が必要となります。また、撮影時に生じる劣化の補正や、診断・手術支援のための3次元可視化も重要な技術です。


- **講義の流れ：**  
  本講義では、下記の流れで画像再構成・3次元化技術について説明します。

  1. 前回までの復習：フーリエ変換とフィルタリング
  2. 画像再構成の基本原理と手法
  3. 実習

---

## 2. 前回までの復習

### 2.1 ディジタル画像の基礎
- **標本化と量子化**：
  - 標本化：連続的な空間情報を離散的な画素に変換（空間解像度）
  - 量子化：連続的な輝度値を離散的な数値に変換（輝度解像度）

### 2.2 エイリアシングとナイキスト定理
- **標本化定理（ナイキスト定理）**：
  信号の最高周波数成分 $f_{\max}$ に対して、標本化周波数 $f_s$ が
  $$f_s \geq 2f_{\max}$$
  を満たさなければ、元の信号を正確に復元できない

- **エイリアシング（折り返し歪み）**：
  標本化定理を満たさない場合に生じる偽の周波数成分の出現

### 2.3 フーリエ変換の基礎
**2次元フーリエ変換（画像処理用）：**

空間領域と周波数領域を変換する数学的手法。

フーリエ変換：

$$F(u,v) = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} f(x,y) e^{-j2\pi(ux+vy)} dx dy$$

逆フーリエ変換：

$$f(x,y) = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} F(u,v) e^{j2\pi(ux+vy)} du dv$$


<figure>
  <img src="../img/03-02.png" alt="1次元フーリエ変換の概念" width="800" height="auto">
  <figcaption>1次元フーリエ変換の概念（引用：https://dibyendu-biswas.medium.com/fourier-transform-70ae1b7ec252）</figcaption>
</figure>

### 2.4 画像フィルタリングの基本
- **空間領域フィルタリングと周波数領域フィルタリング**：
  
空間領域での畳み込み演算は、周波数領域での単純な乗算に対応しています。


$$g(x,y) = f(x,y) \otimes h(x,y) \Leftrightarrow G(u,v) = F(u,v) × H(u,v)$$

ここで、$\otimes$は畳み込み演算、$×$は要素ごとの乗算、$F(u,v)$と$H(u,v)$はそれぞれ$f(x,y)$と$h(x,y)$のフーリエ変換です。

<figure>
  <img src="../img/03-06.png" alt="畳み込み定理" width="800" height="auto">
  <figcaption>畳み込み定理：空間領域の畳み込みと周波数領域の乗算の対応</figcaption>
</figure>

- **代表的なフィルタ**：

#### フィルタの主な種類:

1. **低域通過フィルタ（ローパスフィルタ, LPF）**:
      - 低周波成分を通過させ、高周波成分を除去する
2. **高域通過フィルタ（ハイパスフィルタ, HPF）**:
      - 高周波成分を通過させ、低周波成分を除去する
3. **帯域通過フィルタ（バンドパスフィルタ, BPF）**:
      - 特定の周波数帯域のみを通過させる
4. **帯域除去フィルタ（バンドストップフィルタ, BSF）**:
      - 特定の周波数帯域を除去する

<figure>
  <img src="../img/03-07.png" alt="各種フィルタの周波数特性" width="800" height="auto">
  <figcaption>各種フィルタの周波数特性と通過帯域</figcaption>
</figure>


---

## 3. 画像再構成の基本原理

医用画像の再構成は、間接的に計測されたデータから、生体内部の構造や機能を表す画像を数学的に生成するプロセスです。

特にMRI画像は周波数空間でのデータ収集なので逆フーリエ変換による再構成、CTや核医学検査では、**投影データから断面画像を再構成**する技術が不可欠です。

<figure>
  <img src="../img/04-01.png" alt="投影データから画像再構成の概念図" width="1000" height="auto">
  <figcaption>医療装置毎のデータ収集プロセスの概念図</figcaption>
</figure>

### 3.1 投影データからの画像再構成

#### 3.1.1 医用画像診断装置の多様性と画像再構成の重要性


-  **画像再構成の必要性:  なぜ画像再構成が必要なのでしょうか？**：

    現代の医療では、様々な物理現象を利用した多様な画像診断装置が使用されています。

    各装置は異なる物理現象を利用し、**直接的に画像が得られるわけではない**ものが多くあります。

    多くの装置では、間接的なデータから画像を「**再構成**」するプロセスが必要です。

  1. **直接見えないものを可視化するため**：
     体内の断層像は直接撮影できないため、様々な方向からの投影データや信号から数学的に再構成する必要があります。
  
  2. **異なる装置に適した再構成法が必要**：
     CTとMRIでは取得するデータの性質が全く異なるため、それぞれに適した再構成手法が必要です。
  
  3. **画質と診断精度に直結**：
     再構成方法の選択や設定は、最終的な画像の質や診断能に大きく影響します。



**医用画像診断装置の基本特性比較表**

| 装置 | 基本原理 | 画像形成 | 収集データ | 主な再構成法 |
|------|----------|----------|------------|--------------|
| X線撮影装置 | X線の透過率の違いを利用<br>（骨など高吸収構造の描出に優れる） | 直接投影による形成<br>（重なりのある2次元投影像） | 空間的な投影データ<br>（空間領域での直接取得） | なし（直接画像形成） |
| X線CT装置 | 多方向からのX線透過データを利用<br>（重なりのない断層像、CT値の定量評価） | 投影データから断層像を数学的に再構成<br>（間接的画像形成） | **投影データ**（サイノグラム）<br>（投影領域） | ・フィルタ補正逆投影法（FBP）<br>・反復的再構成法<br> |
| MRI装置 | 核磁気共鳴現象を利用<br>（軟部組織のコントラスト分解能に優れる） | k空間データからフーリエ変換で再構成<br>（間接的画像形成） | k空間データ<br>（純粋な周波数領域） | ・2D/3Dフーリエ変換<br>・非カルテシアン再構成 |
| 超音波装置 | 超音波の反射と散乱を利用<br>（リアルタイム性に優れる） | エコー信号の振幅と到達時間から構成<br>（Aモード/Bモード/Mモードなど表示法多様） | エコー信号（時間-振幅信号）<br>（空間領域での直接取得） | ・ビームフォーミング<br>・合成開口法<br>（比較的単純な空間マッピング） |
| 核医学装置<br>(PET/SPECT) | 放射性同位元素からのガンマ線検出<br>（代謝・機能情報、高感度だが低空間分解能） | 投影データから断層像を再構成<br>（間接的画像形成） | **投影データ**<br>（投影領域） | ・フィルタ補正逆投影法（FBP）<br>・反復的再構成法 |



---

#### 3.1.2 投影の概念

- **投影（Projection）**：  

  投影とは、対象物の特性（例えば密度や線減弱係数）を特定の方向に沿って積分した値です。CTの場合、物体にX線を照射し、**物体を通過したX線の減衰量**が**投影データ**となります。

  実際のX線CTでは、X線の強度$I₀$が物体を通過した後の強度$I$が次のように表されます：
  
  $$
  I = I₀exp(-∫_lf(x,y)dl)
  $$
  
  ここで、$f(x,y)$は物体の線減弱係数分布、$l$はX線の経路を表します。
  
<figure>
  <img src="../img/04-02.png" alt="X線源から検出器でX線強度を検出する様子" width="500" height="auto">
  <figcaption>X線源から検出器でX線強度を検出する様子（引用：篠原 広行，中世古 和真，坂口 和也，橋本 雄幸『逐次近似画像再構成の基礎』医療科学社）</figcaption>
</figure>

    
  ただし、CTでは複数の角度からX線を照射、検出します。
  
  $y$軸に対する回転角度を$\theta$、座標系$(x,y)$に対して、$\theta$だけ回転した座標系を$(X,Y)$としましょう。

  この時、回転した座標系の$Y$軸に沿って（先ほどの例では経路$l$）、強度$I_0$のX線を照射して計測したデータを$I（X, \theta）$とすると、

  $$
  I(X,\theta) = I₀exp(-\int_{-\infty}^{\infty}f(x,y)dY)
  $$

  ここで、開区間$(-\infty, \infty)$の範囲で積分しているのは、$Y$軸に沿った全ての範囲について積分しているためです。

  両辺を整理して対数を取ると、

  $$
  ln(\frac{I_0}{I(X,\theta)}) = \int_{-\infty}^{\infty}f(x,y)dY
  $$
  左辺を$p(X,\theta)$と置くと、
  $$
  p(X,\theta) = \int_{-\infty}^{\infty}f(x,y)dY
  $$
  実際のCT計測においては、この$p(X,\theta)$を生データとして取得し、これを**投影データ**と呼びます。

<figure>
  <img src="../img/04-03.png" alt="X線源から検出器でX線強度を検出する様子" width="600" height="auto">
  <figcaption>座標系を含めたX線CTの計測（引用：篠原 広行，中世古 和真，坂口 和也，橋本 雄幸『逐次近似画像再構成の基礎』医療科学社）</figcaption>
</figure>

- **逆投影（Back Projection）**：  

**逆投影**とは次式のように投影データを被写体の方向に向かって直線状にデータを加えていく操作です。

取得した**投影データ**から、**逆投影**して元の構造を作り出す操作が、CT画像における**再構成**の基盤です。

<figure>
  <img src="../img/04-04.png" alt="複数角度における投影データと逆投影" width="700" height="auto">
  <figcaption>複数角度における投影データと逆投影（引用：篠原 広行，中世古 和真，坂口 和也，橋本 雄幸『逐次近似画像再構成の基礎』医療科学社）</figcaption>
</figure>

- **ラドン変換**

  本講では詳細は割愛しますが、2次元平面上で定義された関数（例えば画像や物体の密度分布）から、その各方向への投影データを得るための積分変換を**ラドン変換**、投影データから元の関数に戻す操作を**逆ラドン変換**と呼びます。

  CT計測においては、投影データを生データとして取得するわけなので、**被写体の断面の減弱係数$f(x,y)$からラドン変換を通じて投影データ$p(X,\theta)$を求めることに相当**します。
  
  一方で、再構成は**投影データに逆ラドン変換を施す**ことで元の構造を推定することに対応します（フーリエ変換とラドン変換との関係（**投影切断定理**）を利用した再構成法はフーリエ変換法と呼ぶ[割愛]）。


#### 3.1.3 サイノグラムと再構成
  CTスキャンにおいて計測されるのは、下記で表される**投影データ**であることが分かりました。

  $$
  p(X,\theta) = \int_{-\infty}^{\infty} f(x,y) dY
  $$

  この投影データをさまざまな回転角度$\theta$、角度$\theta$において投影される軸$X$の位置を並べたデータ（集合）を**「サイノグラム」**と呼びます。
  
  サイノグラムは、横軸が$X$、縦軸が$\theta$となる2次元データであり、CTの基本的な生データ形式です。
  
  CTではこのサイノグラムを元に、逆ラドン変換などの手法を用いて断層画像を再構成します。

  逆問題は測定した投影データ$p(X,\theta)$から未知の被写体断面$f(x,y)$を再構成することになります。

<figure>
  <img src="../img/04-05.png" alt="サイノグラム" width="700" height="auto">
  <figcaption>サイノグラム</figcaption>
</figure>


投影データにおける画像再構成には、大きく分けて解析的手法と反復的手法があります：

1. **解析的手法**：
     - フーリエ変換法：投影データを1Dフーリエ変換->2D逆フーリエ変換とすることで元の空間領域データを再構成できる（**投影スライス定理**の理解が必要[割愛]）
     - **フィルタ補正逆投影法（FBP）**：最も広く使われる手法

2. **反復的手法**：
    - 代数的再構成技法（ART）：投影と逆投影を繰り返し使用
    - 統計的再構成法：ノイズモデルを考慮した反復法
    - モデルベース反復再構成（MBIR）：物理的なモデルを組み込んだ高度な反復法

これらの手法は、装置の特性や求める画質、計算時間などの要素を考慮して選択されます。

---

### 3.2 フィルタ補正逆投影法（FBP: Filtered Back Projection）

#### 3.2.1 単純逆投影法の問題点
- **単純逆投影法（Simple Back Projection）**：
  投影データを収集角度に沿って画像空間に逆投影する手法
    
  問題点：結果はボケた画像となり、正確な再構成ができない（スターアーチファクト）

#### 3.2.2 フィルタ補正逆投影法の原理
- **フィルタ補正逆投影法**：
  投影データに適切なフィルタ（一般にランプフィルタ）を適用した後に逆投影を行う手法
  
  
#### 3.2.3 FBPの実装手順
1. 様々な角度から投影データを収集
2. 各投影データにフーリエ変換を適用
3. 周波数領域でランプフィルタを乗算
4. 逆フーリエ変換でフィルタ処理された投影データを得る
5. フィルタ処理された投影データを逆投影して画像再構成

<figure>
  <img src="../img/04-06.png" alt="単純逆投影法とFBP（ランプフィルタ）" width="500" height="auto">
  <figcaption>単純逆投影法とFBP（引用：https://jsnc.org/p-jsnc-seminar/001/2010/0719-9）</figcaption>
</figure>

<div style="text-align: center; margin: 20px 0;">
<a href="../html/04/04-01.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 再構成シミュレーション①</strong></h4>
</a>
</div>



---

### 3.3 反復的再構成法

FBP法は計算効率が良く広く使われていますが、ノイズや少ないデータでの再構成に弱点があります。

そこで、モデルベースの反復的手法が開発されました。

反復的再構成法では、**「計測された投影データ」を正解として、「画素の理論的な推定値」が近づくように繰り返し画像解を導出**します。

画像と投影データの間に成り立つべき数学的関係を反復的に満たしていくことで、最終的に実測データと一致する画像解を導出することができます。

#### 3.3.1 代数的再構成法（ART: Algebraic Reconstruction Technique）
  画像再構成問題を連立方程式の解法として扱う手法
  
  $$
  p_i = \sum_{j=1}^{N} w_{ij} f_j
  $$
  
  ここで $p_i$ は投影データ、$f_j$ は画素値、$w_{ij}$ は重み係数（投影線と画素の幾何学的関係）を表します。

- **反復更新式**：
  $$
  f_j^{(k+1)} = f_j^{(k)} + \lambda \frac{p_i - \sum_{j} w_{ij} f_j^{(k)}}{\sum_{j} w_{ij}^2} w_{ij}
  $$
  
  ここで $\lambda$ は緩和パラメータ、$k$ は反復回数を表します。

#### 3.3.2 最尤推定法を用いた再構成（ML-EM法: Maximum Likelihood Expectation Maximization）
- **ポアソンノイズモデル**に基づく最尤推定
  
  $$
  f_j^{(k+1)} = \frac{f_j^{(k)}}{\sum_{i} w_{ij}} \sum_{i} \frac{p_i w_{ij}}{\sum_{j'} w_{ij'} f_{j'}^{(k)}}
  $$

#### 3.3.3 逐次近似再構成法（OS-EM: Ordered Subset Expectation Maximization）
- ML-EM法を高速化するために、投影データをサブセットに分割して処理

#### 3.3.4 モデルベース反復再構成法（MBIR: Model-Based Iterative Reconstruction）
- 撮影システムの物理特性（検出器応答、散乱、ビームハードニングなど）を詳細にモデル化
- 事前知識（解の滑らかさなど）を正則化項として組み込む
- 優れた画質と低ノイズを実現するが、計算コストが高い

<figure>
  <img src="../img/04-07.png" alt="FBPと反復法の比較" width="800" height="auto">
  <figcaption>再構成手法の比較（引用：Chrysostomou, Charalambos, et al. "Spect imaging reconstruction method based on deep convolutional neural network." 2019 IEEE Nuclear Science Symposium and Medical Imaging Conference (NSS/MIC). IEEE, 2019.）</figcaption>
</figure>

### 3.4 再構成法の比較と選択

| 再構成法 | 長所 | 短所 | 主な応用 |
|---------|------|------|----------|
| 単純逆投影法 | 計算が最も簡単 | 画質が不十分（ボケ） | 教育目的のみ |
| FBP法 | 計算効率が良い<br>実装が比較的容易 | ノイズに弱い<br>金属アーチファクトが出やすい | 従来型CT<br>一般X線CT |
| 反復的再構成法 | ノイズに強い<br>少ないデータでも再構成可能<br>モデルの柔軟性 | 計算コストが高い<br>パラメータ調整が必要 | 最新型CT<br>低線量CT<br>PET/SPECT |


<div style="text-align: center; margin: 20px 0;">
<a href="../html/04/04-02.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 再構成シミュレーション②</strong></h4>
</a></div>

## 4. まとめ

### 4.1 画像再構成技術のポイント
- 投影データから断層画像を生成する数学的手法
- FBP法と反復的再構成法の特性と選択基準
- 計算効率と画質のトレードオフ

### 4.2 次回講義の予告
- X線画像機器の原理と応用
  - X線の物理的特性と画像形成
  - デジタルX線撮影システム
  - X線画像処理と解析
