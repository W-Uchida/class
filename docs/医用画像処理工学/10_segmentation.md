# 11. Segmentationと特徴量抽出

## 1. 導入・概要

### 1.1 臨床現場での画像解析の重要性

#### 診断支援システムにおける画像処理の役割
近年、CTやMRIなどの医用画像から得られる情報は爆発的に増加しています。医師がすべての画像を詳細に読影するには限界があり、画像処理技術を用いた**診断支援システム（CAD: Computer-Aided Diagnosis）**の重要性が増しています。

<figure>
  <img src="../img/11-01.png" alt="CAD system" width="600" height="auto">
  <figcaption>CAD system</figcaption>
</figure>


#### CAD systemの分類

- **CADe (Computer-Aided Detection):** 病変候補領域の検出支援
- **CADx (Computer-Aided Diagnosis):** 病変の良悪性分類など鑑別による診断支援
- **CAP (Computer-Aided Prediction):** 判断の難しい画像から将来の予測を統計学的に予測

<figure>
  <img src="../img/11-02.png" alt="CAD systemの分類" width="600" height="auto">
  <figcaption>CAD systemの分類</figcaption>
</figure>


### 1.2 今日の学習目標

この講義を通して、以下の3点を達成することを目指します。

1.  **セグメンテーションの基本概念と手法を理解する:** 画像を意味のある領域に分けるとはどういうことか、その目的と代表的な手法の理論的背景を学びます。
2.  **特徴量抽出の手法と臨床応用を学ぶ:** 分割した領域から、診断に役立つ数値（特徴量）を抽出する方法とその意味を理解します。
3.  **CT画像を用いた実践的なプログラミング体験:** Google Colabを使い、実際のCT画像に対してセグメンテーションと特徴量抽出を体験します。

---

## 2. 画像セグメンテーションの基礎

### 2.1 セグメンテーションとは

#### 定義
**セグメンテーション（Segmentation）**とは、デジタル画像を**意味のある複数の領域（セグメント）に分割する処理**のことです。簡単に言えば、「画像の中から目的のモノ（臓器、組織、病変など）を見つけ出し、その輪郭を特定する」プロセスです。

#### 医用画像における目的

- **臓器・病変の抽出:** 脳の灰白質・白質や、肝臓・腎臓・腫瘍領域を正確に抜き出す。
- **体積・面積の定量計測:** 腫瘍の体積を計算し、治療効果を判定したり、脳の萎縮度を海馬の体積で評価したりする。
- **治療計画への応用:** 放射線治療計画（RTP）で、照射範囲（ターゲット）と避けるべき正常組織（OAR: Organ at Risk）を定義する。

<figure>
  <img src="../img/11-03.png" alt="CAD systemの例（乳がん）" width="600" height="auto">
  <figcaption>CAD systemの例（乳がん）</figcaption>
</figure>

<div style="text-align: center; margin: 20px 0;">
<a href="https://reili.fujifilm.com/en/tag/segmentation/index.html" style="display: inline-block; padding: 1px 24px; background-color:rgb(238, 248, 179); color: black; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍セグメンテーション活用例（富士フィルムメディカル）</strong></h4>
</a></div>


### 2.2 主要な手法の分類と理論

セグメンテーションには様々なアプローチが存在します。ここでは代表的な4つの手法について、その理論的背景を少し詳しく見ていきましょう。

#### 1. 閾値処理（Thresholding）
画像の輝度値（ピクセルの明るさ）に基づいて分割する最もシンプルな手法です。

- **理論的背景:** この手法の根底には、「セグメンテーションしたい対象と背景は、異なる輝度値の分布を持つ」という仮定があります。この輝度値の分布を可視化したものが**ヒストグラム**です。対象と背景のヒストグラムが2つの山としてきれいに分かれていれば、その谷間の値を閾値（$T$）として設定します。

$$
\text{出力ピクセル} \in \text{{0,1}} 
$$

- **二値化**
 
ヒストグラムベースの閾値処理により、定義された閾値を超える画素を一般に白（=1）、下回る画素を黒（=0）とすることで、グレースケール画像などの濃淡のある画像を、白と黒の2色のみで表現する画像処理技術

<figure>
  <img src="../img/11-04.png" alt="2値化" width="600" height="auto">
  <figcaption>二値化</figcaption>
</figure>


- **大津の二値化:** 手動で閾値を決めるのは大変ですが、大津の二値化はそれを自動で行うアルゴリズムです。これは、閾値Tで画像を2つのクラス（C0, C1）に分けたとき、「各クラス内の輝度値のばらつき（分散）が最も小さくなる」ような$T$を自動的に見つけ出します。これは数学的に「クラス間の分散が最大になる」ことと同じで、最も分離が良い閾値を選んでくれます。

$$
\text{分離度} = \frac{\text{クラス間分散}}{\text{クラス内分散}}
$$

#### 2. エッジベース手法
領域の境界（エッジ）を検出することに焦点を当て、そのエッジで領域を分割する手法です。

- **理論的背景:** エッジとは「輝度値が急激に変化している点」です。数学的に「変化率」を扱うのは**微分**です。画像に微分フィルタ（**Sobelフィルタ**や**Prewittフィルタ**など）を適用すると、輝度値の変化が大きいエッジ部分で出力値が大きくなり、エッジを検出できます。

<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-06.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 空間フィルタリング</strong></h4>
</a>
</div>

- **Canny エッジ検出:** 単純な微分フィルタはノイズに弱いという欠点があります。Canny法は、以下の複数のステップを組み合わせることで、ノイズに強く、途切れにくいきれいなエッジを検出できる優れたアルゴリズムです。
    1.  **ノイズ除去:** ガウシアンフィルタで画像を平滑化し、ノイズを低減します。
    2.  **勾配計算:** Sobelフィルタなどで輝度勾配（変化の方向と強さ）を計算します。
    3.  **非極大値抑制:** エッジを細い線にするため、勾配方向で極大値でないピクセルを除去します。
    4.  **ヒステリシス閾値処理:** 2つの閾値（上限・下限）を用います。上限閾値を超えたピクセルを「確実なエッジ」とし、そのピクセルに繋がっているピクセルのうち、下限閾値を超えているものもエッジとして採用します。これにより、ノイズによる偽エッジを抑制しつつ、途切れにくいエッジを実現します。

<figure>
  <img src="../img/11-05.png" alt="Cannyエッジ検出" width="600" height="auto">
  <figcaption>Cannyエッジ検出</figcaption>
</figure>

#### 3. 領域ベース手法
「同じ領域内は似たようなピクセルで構成される」という考えに基づき、ピクセルをグループ化していく手法です。

- **領域成長法（Region Growing）:**
    - **アルゴリズム:**
        1. ユーザーが領域の「種」となる**シード点**を画像上に指定します。
        2. シード点の隣のピクセルを調べ、輝度値などがシード点と似ているか（**類似性基準**を満たすか）を判定します。
        3. 基準を満たしたピクセルを領域に取り込み、そのピクセルを新たな探索対象とします。
        4. これを繰り返し、領域がこれ以上成長しなくなったら停止します。
    - **特徴:** 直感的で、特定の連結した領域を抽出したい場合に非常に強力です。しかし、シード点の選び方や類似性基準の設定が結果を大きく左右します。


<figure>
  <img src="../img/11-06.png" alt="Region Growing" width="600" height="auto">
  <figcaption>Region Growing (引用：Zhang, Xiaoli, Xiongfei Li, and Yuncong Feng. "A medical image segmentation algorithm based on bi-directional region growing." Optik 126.20 (2015): 2398-2404.)</figcaption>
</figure>

#### 4. クラスタリング手法
教師なし学習の一種で、画像内のピクセルを特徴（輝度値など）が似ているグループ（クラスタ）に自動的に分類する手法です。

- **K-means クラスタリング:**
    - **アルゴリズム:**
      新しい観測値 𝐱 に対して、訓練データから最も近い**距離**の𝒌個（任意）の観測値を見つけ、その𝒌個の属するクラスの多数決でクラスを決定するノンパラメトリック手法。
    - **特徴:** シンプルで高速ですが、クラスタ数Kを事前に決める必要があります。また、ピクセルの空間的な位置関係を考慮しないため、離れた場所にある同じ輝度値のピクセル（例えば、結節と骨）が同じクラスタに分類されてしまうことがあります。


<figure>
  <img src="../img/11-07.png" alt="k-means" width="600" height="auto">
  <figcaption>k-meansクラスタリング</figcaption>
</figure>


- **距離の定義**

p次元ベクトル $\mathbf{x}_i$ と $\mathbf{x}_j$ の間のユークリッド距離：

$$d(\mathbf{x}_i, \mathbf{x}_j) = \sqrt{\sum_{l=1}^{p} (x_{il} - x_{jl})^2}$$

- **目的関数**

クラスタ内分散の総和を最小化：

$$\arg\min_{C_1, C_2, \ldots, C_k} \sum_{j=1}^{k} \sum_{\mathbf{x}_i \in C_j} \|\mathbf{x}_i - \mathbf{c}_j\|^2$$

ここで：

- $C_j$：j番目のクラスタに属するデータ点の集合
- $\mathbf{c}_j$：j番目のクラスタの重心（セントロイド）



### 2.3 Segmentationの精度評価

自動セグメンテーションの結果は、必ずその精度を評価する必要があります。

- **セグメンテーション精度の評価指標:**

  - **Dice係数 (Dice Coefficient):** 2つの領域の重なり具合を示す指標。1に近いほど一致している。 
$$
\text{DICE index} = \frac{2 * |A ∩ B|}{(|A| + |B|)}
$$

- **手動描画との比較検証 (Ground Truth):** 放射線科医などが手作業で作成した「正解データ」と自動セグメンテーションの結果を比較し、精度を検証します。
- **再現性の確保:** 同じデータに対して、何度実行しても同じ結果が得られることが重要です。


### 2.4 実際の臨床応用例

- **脳画像解析:**

    - **脳容積測定:** アルツハイマー病などにおける脳の萎縮度を定量評価。
    - **病変検出・追跡:** 多発性硬化症の病変（プラーク）の数や体積を経時的に追跡し、治療効果を判定。

- **心臓画像解析:**

    - **左室機能評価:** MRIシネ画像から心筋壁を自動抽出し、心筋の厚さや動き、駆出率を計算。

- **腹部画像解析:**

    - **肝容積測定:** 肝移植手術前のドナー・レシピエントの肝臓体積を正確に計算。
    - **腫瘍サイズ評価:** 固形がんの治療効果判定を支援。

---

## 3. 特徴量抽出の基礎

セグメンテーションで抽出した領域は、まだ「画像の断片」に過ぎません。ここから診断に有用な**定量的数値情報**を取り出すのが**特徴量抽出**です。

### 3.1 特徴量とは

**特徴量（Feature）**とは、画像やセグメント化された領域から抽出される**数値的な特性**のことです。画像そのものではなく、その特徴を表現する数値のセットに変換することで、定量的解析や機械学習モデルの入力として利用できるようになります。

### 3.2 形状特徴量

領域の形や大きさに関する特徴量です。

#### 基本的な幾何学的特徴

- **面積 (Area):** 領域に含まれるピクセルの総数。臓器や腫瘍の大きさを表します。
- **周囲長 (Perimeter):** 領域の境界の長さ。
- **重心座標 (Centroid):** 領域の幾何学的な中心位置。
- **円形度 (Circularity):** 領域がどれだけ円に近いかを示す指標。`4 * π * 面積 / (周囲長^2)` で計算され、真円で1に近づきます。腫瘍の形状評価（円形に近いか、いびつか）などに使われます。
- **アスペクト比 (Aspect Ratio):** 領域を囲む最小の長方形（バウンディングボックス）の幅と高さの比。領域の細長さを示します。

#### 臨床応用例

- **腫瘍の大きさ・形状評価:** 治療前後での面積や体積の変化を追跡。円形度がいびつなほど悪性の可能性を示唆する場合もあります。
- **心機能解析:** MRIのシネ画像から左心室をセグメンテーションし、各時相での容積を計算することで、駆出率（EF: Ejection Fraction）などの心機能指標を算出します。

### 3.3 テクスチャ特徴量

領域内部のピクセルの輝度値の分布や空間的な関係性から、その領域の「質感」を表現する特徴量です。

#### 統計的特徴量

- **平均値 (Mean):** 領域内の輝度値の平均。領域全体の明るさを示します。
- **標準偏差 (Standard Deviation):** 輝度値のばらつき。値が大きいほど、領域内のコントラストが高いことを意味します。
- **ヒストグラム特徴:** 輝度値の分布（ヒストグラム）から得られる特徴。歪度（分布の歪み）や尖度（分布の鋭さ）などがあります。


#### 臨床応用例

- **組織性状の定量評価:** 同じ臓器でも、正常組織とがん組織ではテクスチャが異なる場合があります。GLCM特徴量を用いて、その違いを数値化します。
- **病変の良悪性鑑別支援:** 形状特徴量だけでは判断が難しい場合に、テクスチャ特徴量を補助的に用いて良性か悪性かを鑑別する研究が進められています（ラジオミクス）。


---

## 4. Google Colab実習

- [Google colabファイル](https://drive.google.com/file/d/1C1eHqvdKEKn9Umg8S1IvjCj5PS0CntVx/view?usp=sharing)
- [演習用画像1 (ファントム)](https://drive.google.com/file/d/1HFByI-I_uA1HqYFTU8idIbKKjvux4bxB/view?usp=sharing)
- [演習用画像2 (CT)](https://drive.google.com/file/d/10_gqAiXzNtTjjRLMIaK_gtUj_LvvQUzG/view?usp=sharing)

---
## 5. まとめ

### 5.1 重要ポイントの復習

1.  **セグメンテーション手法の選択基準:**
    - 画像の特性（コントラスト、ノイズ）や目的（輪郭か、領域か）に応じて最適な手法を選択する必要があります（例: コントラストが明瞭なら閾値処理、複雑な組織分類ならクラスタリングや深層学習）。
2.  **特徴量の臨床的意義:**
    - 抽出した数値（面積、円形度、コントラスト等）が、臨床的に何を意味するのか（腫瘍の大きさ、形状のいびつさ、組織の不均一性等）を理解することが、解析結果を解釈する上で不可欠です。
3.  **実装時の注意点:**
    - 前処理（ノイズ除去など）は、後段の解析精度に大きく影響します。
    - 結果の精度は必ず評価し、その限界を理解した上で利用することが重要です。


## 6. 演習課題

- [Google Form](https://docs.google.com/forms/d/e/1FAIpQLSeF3cyf_9Bv9OFTbmVsH-XZq2Gj7aAtYQTm4Ipkh84qWuBykA/viewform?usp=sharing&ouid=102691845603378234488)

<figure>
  <img src="/img/11-08.png" alt="第11回演習QRコード" width="300" height="auto">
  <figcaption>第11回演習QRコード</figcaption>
</figure>