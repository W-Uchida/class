# 12. Registrationとモダリティ融合

## 1. 導入・概要

本日は「Registrationとモダリティ融合」というテーマでお話しします。皆さんの日常業務において、CTやMRI、PETといった様々な画像診断装置に触れる機会が多いと思います。これらの画像は、単体でも非常に有用ですが、**複数の画像を組み合わせる**ことで、診断や治療の質を劇的に向上させることができます。

### 1.1 臨床現場でのモダリティ融合の重要性

なぜ、今モダリティ融合が重要なのでしょうか？

-   **診断精度の向上**: CTで捉えた詳細な「形（解剖学的情報）」と、PETで捉えたがんの「活動（機能的情報）」を重ね合わせることで、腫瘍の位置と広がりをより正確に特定できます。
-   **治療計画・手術ナビゲーション**:
    -   **放射線治療**: 腫瘍の正確な位置に線量を集中させるため、治療計画CTと診断用のMRI/PET画像を高い精度で位置合わせ（Registration）します。
    -   **手術支援**: 術前のMRI画像で特定した腫瘍や重要な神経の位置を、術中の患者さんの体に投影するナビゲーションシステムは、まさにRegistration技術の賜物です。


以下United image HPより。

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
  <figure>
    <img src="../img/12-01.png" alt="Registrationの例1" width="70%" height="auto">
    <figcaption>Registrationの例1</figcaption>
  </figure>
  
  <figure>
    <img src="../img/12-02.png" alt="Registrationの例2" width="70%" height="auto">
    <figcaption>Registrationの例2</figcaption>
  </figure>
</div>


### 1.2 今日の学習目標

この90分間で、以下の3点を達成することを目指します。

1.  **画像Registrationの基本を理解する**: 「位置合わせ」とは何か、どのような手法があるのか、その概念と分類を学びます。
2.  **モダリティ融合の目的と利点を学ぶ**: なぜCTとMRIを重ねるのか？そのメリットと臨床応用を理解します。
3.  **臨床工学技士としての役割を考える**: この技術分野において、私たちがどのように貢献できるのか、その視点を得ます。

---

## 2. 画像Registrationの基礎

### 2.1 Registrationとは？

**Registration**とは、一言で言えば**「異なる画像間で、空間的な位置を合わせること」**です。日本語では「位置合わせ」や「位置決め」と訳されます。


<figure>
  <img src="../img/12-03.png" alt="Registration" width="600" height="auto">
  <figcaption>Registration</figcaption>
</figure>


では、なぜ医用画像でRegistrationが必要なのでしょうか？

-   **同一患者・複数検査の統合**:
    -   CTとMRIなど、異なるモダリティの画像を重ね、情報を補完し合うため。
    -   これが今日のメインテーマである**モダリティ融合**の前提となります。
-   **経時的変化の追跡**:
    -   治療前の画像と治療後の画像を比較し、腫瘍の縮小効果や病変の進行を定量的に評価するため。
-   **標準脳（アトラス）との比較**:
    -   患者さんの脳画像を、標準的な脳の地図（アトラス）と照らし合わせ、どの部位に異常があるかを特定するため。

### 2.2 Registration手法の分類

Registrationは、画像の「動かし方（変換の種類）」と「何を基準に合わせるか」によって分類できます。

#### 2.2.1 変換の種類：どう動かすか？

1.  **剛体変換 (Rigid Transformation)**
    -   **動き**: 平行移動 (ずらす) + 回転 (まわす) のみ。
    -   **特徴**: 形や大きさは一切変わらない、まさに「剛体」のような動き。
    -   **適用例**: 頭蓋骨や骨盤など、変形しない硬い組織の位置合わせ。CTとMRIでの頭部の位置合わせなど。

2.  **アフィン変換 (Affine Transformation)**
    -   **動き**: 剛体変換 + 拡大・縮小 + せん断 (ひしゃげる)。
    -   **特徴**: 平行な線は平行なまま保たれますが、全体のサイズや角度が変わります。
    -   **適用例**: 撮像時のスキャナの違いによる画像の歪みや、おおまかな体の向きの違いを補正する際に使われます。

3.  **非線形変換 (Non-rigid / Deformable Transformation)**
    -   **動き**: 局所的な、グニャグニャとした変形を許容します。
    -   **特徴**: 最も自由度の高い変換で、軟部組織の変形に対応できます。
    -   **適用例**:
        -   呼吸による肺や肝臓の動きの補正。
        -   治療による腫瘍の縮小や、手術中の脳の変形（ブレインシフト）の追跡。


<figure>
  <img src="../img/12-04.png" alt="Registrationの種類" width="600" height="auto">
  <figcaption>Registrationの種類（引用：大竹義人. "医用画像解析・手術支援システムにおけるレジストレーション." Medical Imaging Technology 35.1 (2017): 11-17.）</figcaption>
</figure>

#### 2.2.2 基準による分類：何を頼りに合わせるか？

1.  **特徴点ベース (Feature-based)**
    -   **方法**: 両方の画像で対応がつく「目印（ランドマーク）」を複数指定し、その点同士が重なるように画像を変換します。
    -   **長所**: 直感的で、計算が速い。
    -   **短所**:
        -   **手動設定**: 手間がかかり、担当者によって精度がばらつく。
        -   **自動検出**: 明確なランドマークがない画像では難しい。

2.  **強度ベース (Intensity-based)**
    -   **方法**: 画像全体のピクセル値（輝度値）のパターンが最も似るように、少しずつ画像を動かしながら最適な位置を探します。
    -   **長所**: ランドマークが不要で、客観的かつ高精度な位置合わせが可能。現在の主流。
    -   **短所**: 計算コストが高い。初期位置が大きくずれていると失敗することがある。


#### 2.3 強度ベースで使われる類似度指標（どのくらいあっているか？）

強度ベースの手法では、2つの画像がどれだけ似ているかを数値化する「類似度指標」を計算し、その値が最も良くなる（最大化または最小化する）ように画像を動かします。ここでは、代表的な2つの指標を簡単に紹介します。

1.  **正規化相互相関 (Normalized Cross-Correlation, NCC)**
    -   **いつ使うか？**: 主に**同じモダリティ**の画像間 (例: CTとCT、T1強調MRIとT1強調MRI)
    -   **考え方**: 2つの画像の輝度パターンの「形」がどれだけ似ているかを評価します。画像の明るさやコントラストが全体的に違っていても、山や谷のパターンが似ていれば高いスコアになります。統計学で学ぶ「相関係数」とほぼ同じ考え方で、値が+1に近いほど類似度が高いと判断します。
    -   **数式（イメージ）**:
        $$
        \text{NCC} = \frac{\sum (I_A - \bar{I}_A) \cdot (I_B - \bar{I}_B)}{\sqrt{\sum (I_A - \bar{I}_A)^2} \cdot \sqrt{\sum (I_B - \bar{I}_B)^2}}
        $$
        -   $I_A$, $I_B$: それぞれの画像（A, B）のある点における輝度値（明るさ）。
        -   $\bar{I}_A$, $\bar{I}_B$: それぞれの画像の輝度値の平均値。
        -   $\sum$: 全ての点について合計を取ることを意味します。
        
        数式は複雑に見えますが、やっていることは「画像Aのある点の明るさが、全体の平均よりどれだけズレているか」と「画像Bの対応する点のズレ」を掛け合わせ、全体を合計しているだけです。パターンの上がり下がりが一致していると、値が大きくなります。


2.  **相互情報量 (Mutual Information, MI)**
    -   **いつ使うか？**: **異なるモダリティ**の画像間 (例: CTとMRI、PETとCT)
    -   **考え方（統計学的視点）**: 相互情報量は、情報理論において**「2つの確率変数が統計的に独立な状態からどれだけ離れているか」**を測る尺度です。画像Aの輝度値（確率変数A）を知ることで、画像Bの輝度値（確率変数B）についての不確かさがどれだけ減少するか、とも言い換えられます。

    -   **数式（概念）**:
        $$
        \text{MI}(I_A, I_B) = \sum_{a, b} p(a, b) \log\left(\frac{p(a, b)}{p(a)p(b)}\right)
        $$
        -   $p(a,b)$: 画像Aである輝度値`a`をとり、かつ画像Bで輝度値`b`をとる点が現れる**同時確率**。
        -   $p(a)p(b)$: もし画像AとBが統計的に独立であったと仮定した場合の同時確率。
        -   $\sum_{a, b}$: 考えられる全ての輝度値の組み合わせについて合計を取ることを意味します。

        この式は、実際の同時分布 $p(a,b)$ と、独立を仮定した場合の分布 $p(a)p(b)$ との間の**統計的な隔たり（カルバック・ライブラージャイバージェンス）**を計算しています。2つの分布が離れている（＝依存関係が強い）ほど、値は大きくなります。これにより、輝度値の物理的な意味が全く異なるモダリティ間でも、その統計的な関係性だけを頼りに高精度な位置合わせが実現できるのです。

    -   **独立な状態とは**: 2つの画像の位置が全く対応していない場合、画像Aのとある点の輝度値から、画像Bの同じ位置の輝度値を予測することはできません。この状態が「統計的に独立」であり、

    $$P(a,b) = P(a) \cdot P(b)$$

    が成り立ちます。上の式より、このとき相互情報量は最小値（0）をとります。


    -   **依存関係が生まれると**: 画像を正しく重ね合わせると、「CTで骨に相当する高輝度値の場所は、MRIでは低信号になる」というような**統計的な依存関係**（$P(a,b) \not = P(a) \cdot P(b)$）が生まれます。この依存関係が強くなるほど、相互情報量の値は大きくなります。

    つまり、**相互情報量を最大化することは、2つの画像の輝度値間の統計的依存性を最も強くする変換を探すこと**に他なりません。


<figure>
  <img src="../img/12-05.png" alt="相互情報量" width="600" height="auto">
  <figcaption>相互情報量</figcaption>
</figure>




---

## 3. モダリティ融合の基礎 

### 3.1 医用画像モダリティの特徴比較

モダリティ融合を理解するには、まず各モダリティの「長所」を知る必要があります。

| モダリティ | 得意なこと (長所)                                  | 苦手なこと (短所)                           |
| :--------- | :------------------------------------------------- | :------------------------------------------ |
| **CT**     | **骨や硬い組織の描出**、高い空間分解能、高速撮像     | 軟部組織のコントラストが低い、放射線被ばく    |
| **MRI**    | **軟部組織の優れたコントラスト**、多彩な撮像法、機能情報 | 骨が見えにくい、撮像時間が長い、磁場による制約 |
| **PET**    | **細胞の代謝・機能情報の可視化**、高感度、全身検索   | 解剖学的な位置情報が乏しい、空間分解能が低い  |

### 3.2 融合の目的と利点

なぜこれらの画像をわざわざ融合するのか？それは、**お互いの弱点を補い合い、単独では得られない価値を生み出す**ためです。

-   **補完的情報の統合**:
    -   **解剖学的情報 (CT/MRI) + 機能情報 (PET)**: これが最も古典的で強力な組み合わせです。
        -   **PET-CT**: PETで光って見える「がんの活動部位」が、体のどの「臓器・位置」にあるのかをCT画像上で正確に特定できます。
    -   **異なる組織コントラストの統合**:
        -   **CT-MRI**: CTで得意な「骨」と、MRIで得意な「脳実質や神経」を1つの画像で見ることができ、手術計画などで役立ちます。

---

## 4. 臨床応用と実装課題

### 4.1 具体的な臨床応用例

#### 4.1.1 腫瘍学領域（がん診療）

-   **PET-CT融合**:
    -   **病期診断**: 原発巣だけでなく、リンパ節や遠隔臓器への転移を一度に評価します。
    -   **放射線治療計画**: CTの解剖情報上にPETの機能情報を重ねることで、照射すべき「生物学的標的体積(BTV)」を正確に設定し、正常組織への被ばくを最小限に抑えます。
-   **MRI多シーケンス融合**:
    -   脳腫瘍の手術前に、T1, T2, FLAIR, DTI（神経線維）など複数のMRI画像を融合し、腫瘍の範囲と重要な機能野（運動野、言語野など）との位置関係を把握します。

-   **術中ナビゲーションシステム**:
    -   術前に撮影した高精細なMRI画像と、術中の患者さんの頭部の位置をリアルタイムでRegistrationします。
    -   これにより、執刀医はメスや器具の先端が、脳のどの部分にあるのかをモニター上で確認しながら安全に手術を進めることができます。

#### 4.1.2 循環器領域

-   **心臓CT-MRI融合**:
    -   CTで得られる冠動脈の鮮明な形態情報と、MRIで得られる心筋の性状（虚血、梗塞、線維化など）を統合し、包括的な心疾患評価を行います。

#### 4.1.3 脳神経内科/外科領域

-   **CADとしての脳萎縮計測**:
    - **VSRAD (Voxel-based Specific Regional analysis System for Alzheimer's Disease)** :
    - MRI画像を用いて脳の萎縮の程度を客観的かつ定量的に評価し、アルツハイマー病（AD）の早期診断を支援するために日本で開発されたシステム。VSRADは、その客観的な評価指標と比較的簡便な操作性から、日本国内において医薬品医療機器等法（旧薬事法）に基づく医療機器としての承認を受け、2015年時点で約3000の医療機関でADの診断補助ツールとして臨床応用されている。

<figure>
  <img src="../img/12-06.png" alt="VSRAD" width="600" height="auto">
  <figcaption>VSRAD（引用：https://minoh.keakikai.com/vsrad/）</figcaption>
</figure>

### 4.2 実装上の課題と対策

この素晴らしい技術も、臨床現場で使うにはいくつかの壁があります。

-   **計算コストとリアルタイム性**: 特に非線形Registrationは計算に時間がかかります。術中ナビゲーションのようなリアルタイム性が求められる場面では、**GPU**を用いた高速化や、アルゴリズムの最適化が不可欠です。
-   **精度と再現性**: Registrationの精度は治療結果に直結します。手動操作によるばらつきを減らすための**自動化**や、定期的な**品質管理（QC）**プロトコルの確立が重要です。
-   **標準化と互換性**: 異なるベンダーの装置間で画像をやり取りする際、**DICOM規格**に準拠していても、細かな情報が欠落することがあります。施設内でのデータ連携フローの構築が求められます。


---

## 5. 最新動向と将来展望

### 5.1 AI・機械学習の活用

-   **深層学習によるRegistration**: 大量の正解データペアをAIに学習させることで、従来法より圧倒的に高速（数秒レベル）かつ高精度なRegistrationが可能になりつつあります。
-   **自動ランドマーク検出**: AIが画像から解剖学的な特徴点を自動で検出し、Registrationの初期位置合わせや精度評価に利用する研究が進んでいます。

### 5.2 新しい融合技術

-   **PET-MRI装置**: PETとMRIを一体化させた装置が登場しています。ほぼ同時に撮像できるため、時間的なズレがなく、特に動きのある臓器の評価で高い精度を発揮します。
-   **マルチモーダル統合解析**: 複数の画像モダリティ情報だけでなく、ゲノム情報や血液データなども統合し、AIを用いて疾患の診断や予後予測を行う「ラジオミクス」や「統合診断」といった分野が発展しています。



## 6. Google Colab実習

- [Google colabファイル](https://drive.google.com/file/d/1IC3Mk-BKfPDdGF8oqHc7LTiTdGIAD8om/view?usp=sharing)
