# 3. 講義：画像フィルタリングと画質改善技術

---

## 1. はじめに

### 1.1 講義の目的と全体像

- **背景説明：**  
  医用画像診断において、原画像をそのまま使用するだけでなく、様々な画像処理技術を適用することで診断精度を向上させることができます。特に画像フィルタリングは、ノイズ除去、エッジ強調、構造抽出などに有効な基本技術です。


- **講義の流れ：**  
  本講義では、以下の流れで画像フィルタリングと画質改善技術について説明します。

  1. 実空間と周波数空間の関係（フーリエ変換）
  2. フィルタ処理の基本概念
  3. 空間領域でのフィルタリング（畳み込み処理）
  4. 周波数領域でのフィルタリング
  5. 代表的な画像フィルタとその効果
  6. 医用画像への応用例
  7. 最新の画像処理技術の動向

---


## 1. 信号と周波数の基礎

### 1.1 信号の周波数表現
- **波形と周波数の関係**  
  自然界の信号（音、光、電気信号など）は様々な周波数成分の組み合わせで構成されています。例えば、単純な正弦波は単一の周波数を持ちますが、複雑な波形は様々な周波数成分が混ざり合っています。

- **フーリエの原理**  
  どんなに複雑な波形（信号）も、異なる周波数の正弦波（サイン波とコサイン波）の組み合わせとして表現できるという原理です。これはフランスの数学者ジョゼフ・フーリエによって発見されました。

<figure>
  <img src="../img/03-01.png" alt="矩形波のフーリエ級数近似" width="800" height="auto">
  <figcaption>矩形波のフーリエ級数近似</figcaption>
</figure>

- **なぜわざわざ信号を周波数成分に分解するのか？**  
  
  信号を周波数成分に分解することで、信号の特性をより深く理解し、**その信号値特性に応じて効果的に処理できるようになります**。

  例えば、特定の周波数帯域のノイズだけを除去したり、特定の周波数成分を強調したりすることが可能になります。

  次の項では、前回学んだエイリアシングを例に、周波数特性に応じた質の改善方法（アンチエイリアシング）を考えてみましょう。

## 2. エイリアシングの復習とアンチエイリアシングについて考える

### 2.1 標本化とエイリアシング現象
- **標本化（サンプリング）の基本概念**  
  デジタル画像は本来連続的なアナログ信号を一定間隔で標本化（サンプリング）することで生成されます。標本化間隔（サンプリング間隔$f_s$）は、画質を決定する重要な要素です。

- **サンプリング定理（ナイキストの定理）**  
  信号に含まれる最高周波数の2倍以上の頻度でサンプリングしなければ、信号を正確に再現できないという原理です。
  
$$
fs \geq f_n = 2 × fmax (\text{信号の最大周波数})
$$

- **エイリアシング（折り返し歪み）とは**  
  - サンプリング間隔が粗すぎると、**高周波成分（細かい変化）を正確に捉えることができず**、実際とは異なる低周波の信号として誤って再現されてしまう現象です。これがエイリアシング（別名：折り返し歪み）です。
  - 下記のシミュレーションを再度確認して、特に高周波成分の表現が難しくなる様子を再確認しましょう。

<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-01.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習（復習+α）】 標本化シミュレーション①</strong></h4>
</a>
</div>


### 2.2 アンチエイリアシングの基本原理
- **エイリアシングを避けるにはどうすれば良さそうでしょうか？**
  
  標本化間隔を狭くすれば良い：

　　➡︎ 確かに。ただ、標本化間隔が狭いということは、データ量が大きくなりすぎるし、ハードウェア性能などにも限界がある。

　　データ管理や伝送の観点も考慮する必要がある。


- **「捉えられない高周波成分は事前に取り除く」という考え方**  
  サンプリング周波数の半分（ナイキスト周波数）より高い周波数成分は正確に捉えられないので、サンプリングする前にこれらの成分を取り除けば、エイリアシングを避けられそうです。

<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-02.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 アンチエイリアシング（ローパスフィルタリング）</strong></h4>
</a>
</div>


## 2. 実空間と周波数空間

このように、実空間（信号そのもの）だけでなく、周波数空間（周波数成分の分布）を考えることで、周波数特性毎の処理が可能となり、非常に有用です。

### 2.1 実空間・周波数空間

**実空間と周波数空間の関係：**  
私たちが普段目にする画像は「実空間（空間領域）」の表現です。一方、同じ画像を「周波数空間（周波数領域）」で表現することもできます。

- **実空間（空間領域）**: 画像の各位置(x, y)における明るさ・色を表す
- **周波数空間（周波数領域）**: 画像に含まれる様々な周波数成分の強さを表す

これは音楽に例えると理解しやすいでしょう：

- 実空間：時間経過に伴う音の大きさの変化（波形）

- 周波数空間：低音から高音までの音の強さの分布（音階やスペクトル）


**実空間と周波数空間の行き来は、フーリエ変換（フーリエ逆変換）で行います。**

---

### 2.2 フーリエ変換の基本概念

フーリエ変換は、時間領域（画像の場合は空間領域）の信号を周波数領域に変換する数学的手法です。これにより、信号に含まれる様々な周波数成分を分析することが可能になります。

**フーリエ変換の直感的理解：**

- どんな複雑な周期的信号も、異なる周波数の正弦波（サイン波とコサイン波）の組み合わせで表現できる

- フーリエ変換は、元の信号をこれらの周波数成分に分解する

- 逆フーリエ変換は、周波数成分から元の信号を再構成する


<figure>
  <img src="../img/03-02.png" alt="フーリエ変換の概念" width="800" height="auto">
  <figcaption>フーリエ変換の概念（引用：https://dibyendu-biswas.medium.com/fourier-transform-70ae1b7ec252）</figcaption>
</figure>

**1次元フーリエ変換の数式：**

フーリエ変換：

$$F(\omega) = \int_{-\infty}^{\infty} f(t) e^{-j\omega t} dt$$

逆フーリエ変換：

$$f(t) = \frac{1}{2\pi} \int_{-\infty}^{\infty} F(\omega) e^{j\omega t} d\omega$$

**2次元フーリエ変換（画像処理用）：**

フーリエ変換：

$$F(u,v) = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} f(x,y) e^{-j2\pi(ux+vy)} dx dy$$

逆フーリエ変換：

$$f(x,y) = \int_{-\infty}^{\infty} \int_{-\infty}^{\infty} F(u,v) e^{j2\pi(ux+vy)} du dv$$



<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-03.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 1次元フーリエ変換</strong></h4>
</a>
</div>



### 2.3 画像の周波数成分

画像の周波数成分は、画像内の**明暗変化の頻度**（空間周波数）を表します：

**画像と周波数成分の関係：**  
画像も2次元の信号として考えることができます。画像の明るさの変化は「空間的な信号」であり、以下のように周波数の概念で表現できます：

- **低周波成分**：画像の大まかな明暗や色調の変化（緩やかに変化する部分）
    - 例：空や背景のグラデーション、顔の全体的な明るさ

- **高周波成分**：画像の細かい模様や輪郭（急激に変化する部分）
    - 例：髪の毛、網目模様、物体の境界線

**医用画像の例：**

- 胸部X線写真：肺野の血管影（高周波）と肺野全体の濃度（低周波）
- MRI画像：脳の細かい構造（高周波）と脳の大まかな領域（低周波）


<figure>
  <img src="../img/03-03.png" alt="画像の周波数成分" width="800" height="auto">
  <figcaption>画像の周波数成分の例：低周波成分と高周波成分</figcaption>
</figure>

<figure>
  <img src="../img/03-04.png" alt="CT画像のフーリエ変換" width="800" height="auto">
  <figcaption>CT画像のフーリエ変換</figcaption>
</figure>

<figure>
  <img src="../img/03-05.png" alt="周波数領域の分布" width="800" height="auto">
  <figcaption>周波数領域の分布</figcaption>
</figure>


<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-04.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 2次元フーリエ変換</strong></h4>
</a>
</div>


### 2.4 フーリエ変換の医用画像への応用

医用画像処理におけるフーリエ変換の主な用途：


1. **画像フィルタリング（本講義で扱う）**
      - 特定の周波数成分を強調・抑制して画質改善
      - 例：MRI画像のギブスアーチファクト低減

2. **画像再構成（次回扱う）**
      - CTやMRIの投影データから画像を再構成（フィルタ補正逆投影法など）

3. **画像圧縮（次回できれば扱う）**
      - 重要度の低い周波数成分を削減（JPEG圧縮の基本原理）
  
4. **画像のノイズ解析**
      - ノイズの周波数特性を分析し、最適なフィルタを設計

---

## 3. フィルタ処理の基本概念

### 3.1 空間領域と周波数領域でのフィルタ処理

フィルタは特定の周波数成分を通過させたり、除去したりする処理です。

フィルタ処理は、実空間（空間領域）と周波数空間（周波数領域）の両方で行うことができます。両者には密接な関係があり、それぞれに利点があります。

**空間領域でのフィルタリング：**

- 画像の画素値に直接演算を行う

- シンプルで直感的に理解しやすい

- 局所的な処理に適している

**周波数領域でのフィルタリング：**

- 画像をフーリエ変換して周波数成分に分解し、処理を行う

- 大域的な特性を扱いやすい

- 特定の周波数帯域を正確に処理できる

**両者の関係：畳み込み定理**

空間領域での畳み込み演算は、周波数領域での単純な乗算に対応しています。


$$g(x,y) = f(x,y) \otimes h(x,y) \Leftrightarrow G(u,v) = F(u,v) × H(u,v)$$

ここで、$\otimes$は畳み込み演算、$×$は要素ごとの乗算、$F(u,v)$と$H(u,v)$はそれぞれ$f(x,y)$と$h(x,y)$のフーリエ変換です。

<figure>
  <img src="../img/03-06.png" alt="畳み込み定理" width="800" height="auto">
  <figcaption>畳み込み定理：空間領域の畳み込みと周波数領域の乗算の対応</figcaption>
</figure>


<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-05.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 畳み込み</strong></h4>
</a>
</div>


### 3.2 フィルタの種類と特性
主なフィルタの種類は以下の通りです：

#### フィルタの主な種類:

1. **低域通過フィルタ（ローパスフィルタ, LPF）**:
      - 低周波成分を通過させ、高周波成分を除去する
      - 画像のぼかし効果、ノイズ除去に使用
      - A/D変換前に**エイリアシングを防止**するために使用される重要なフィルタ

2. **高域通過フィルタ（ハイパスフィルタ, HPF）**:
      - 高周波成分を通過させ、低周波成分を除去する
      - エッジ検出や細部の強調に使用
      - 画像のシャープネス向上に利用

3. **帯域通過フィルタ（バンドパスフィルタ, BPF）**:
      - 特定の周波数帯域のみを通過させる
      - 特定の構造やパターンの抽出に有効

4. **帯域除去フィルタ（バンドストップフィルタ, BSF）**:
      - 特定の周波数帯域を除去する
      - 周期的なノイズの除去などに使用

<figure>
  <img src="../img/03-07.png" alt="各種フィルタの周波数特性" width="800" height="auto">
  <figcaption>各種フィルタの周波数特性と通過帯域</figcaption>
</figure>

---

## 4. 空間領域でのフィルタリング

### 4.1 畳み込み処理の基本

空間領域でのフィルタリングは、**畳み込み（コンボリューション）**と呼ばれる操作を使用します。これは、フィルタのカーネル（マスク）と画像を重ね合わせ、対応する画素値の積の和を計算する処理です。

**畳み込み処理の数式**:


$$g(x,y) = f(x,y) \otimes h(x,y) $$

ここで、$f(x,y)$は入力画像、$h(s,t)$はフィルタカーネル、$g(x,y)$は出力画像です。

### 4.2 代表的な空間フィルタ

#### 平滑化フィルタ（移動平均フィルタ）

すべての要素が同じ値（通常は1/n²）の単純なカーネルを使用します。これにより画像がぼやけ、ノイズが低減されます。

**3×3平滑化フィルタの例：**
```
1/9 × [1 1 1]
      [1 1 1]
      [1 1 1]
```

#### ガウシアンフィルタ

2次元ガウス関数に基づくフィルタで、中心ほど重みが大きく、周辺ほど小さくなります。自然なぼかし効果があり、エッジを保持しながらノイズを低減します。

**5×5ガウシアンフィルタの例：**
```
1/273 × [ 1  4  7  4  1]
        [ 4 16 26 16  4]
        [ 7 26 41 26  7]
        [ 4 16 26 16  4]
        [ 1  4  7  4  1]
```

#### 微分フィルタ（エッジ検出）

画像の勾配（明暗の変化率）を計算し、エッジを強調します。

**Sobelフィルタの例：**
```
x方向: [-1 0 1]    y方向: [-1 -2 -1]
       [-2 0 2]           [ 0  0  0]
       [-1 0 1]           [ 1  2  1]
```

**ラプラシアンフィルタの例：**
```
[0  1  0]
[1 -4  1]
[0  1  0]
```

#### メディアンフィルタ

非線形フィルタの一種で、周囲の画素値の中央値を出力します。スパイクノイズ（塩・コショウノイズ）の除去に効果的です。


<div style="text-align: center; margin: 20px 0;">
<a href="../html/03/03-06.html" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 空間フィルタリング</strong></h4>
</a>
</div>

---

## 5. 周波数領域でのフィルタリング

### 5.1 周波数領域フィルタリングの手順

周波数領域でのフィルタリングは、以下の手順で行います：

1. 画像をフーリエ変換して周波数領域に変換する
2. 周波数領域で適切なフィルタを乗算する
3. 逆フーリエ変換して空間領域に戻す

**数式表現：**


$$G(u,v) = F(u,v) \cdot H(u,v)$$


$$g(x,y) = \mathcal{F}^{-1}\{G(u,v)\}$$

ここで、$F(u,v)$は入力画像のフーリエ変換、$H(u,v)$はフィルタの周波数応答、$G(u,v)$はフィルタリング後の周波数領域表現、$\mathcal{F}^{-1}$は逆フーリエ変換を表します。

### 5.2 代表的な周波数領域フィルタ

#### 理想低域通過フィルタ

指定した遮断周波数より低い周波数成分のみを通過させる最もシンプルなフィルタです。


$$H(u,v) = 
\begin{cases} 
1 & \text{if } \sqrt{u^2 + v^2} \leq D_0 \\
0 & \text{if } \sqrt{u^2 + v^2} > D_0
\end{cases}$$

ここで、$D_0$は遮断周波数です。

#### バターワース低域通過フィルタ

より緩やかな遮断特性を持ち、リンギング効果（波紋状のアーティファクト）を軽減します。


$$H(u,v) = \frac{1}{1 + [\frac{\sqrt{u^2 + v^2}}{D_0}]^{2n}}$$

ここで、$n$はフィルタの次数です。

#### ガウシアン低域通過フィルタ

さらに滑らかな特性を持ち、空間領域のガウシアンフィルタに対応します。


$$H(u,v) = e^{-\frac{u^2 + v^2}{2\sigma^2}}$$

ここで、$\sigma$は標準偏差です。

#### 高域通過フィルタ

上記の低域通過フィルタを反転させることで得られます。


$$H_{HP}(u,v) = 1 - H_{LP}(u,v)$$


<div style="text-align: center; margin: 20px 0;">
<a href="https://monman53.github.io/2dfft/" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
<h4><strong>🔍【実習】 周波数フィルタリング</strong></h4>
</a>
</div>

<div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; color: blue;">
<h4><strong>実習用CTデータ</strong></h4>
<a href="../html/03/Lung_CT.jpg" download>Download Lung_CT.jpg</a>
</div>

---

## 6. 医用画像への応用

### 6.1 画像のノイズ除去

医用画像には様々な種類のノイズが存在し、診断精度に影響を与えます。適切なフィルタ処理によりノイズを低減できます。

**主なノイズの種類：**

- ガウスノイズ（熱雑音）：電子回路に起因する加算的なノイズ

- スパイクノイズ（塩・コショウノイズ）：センサー不良などによる孤立した輝点

- 量子ノイズ（ショットノイズ）：X線光子数の統計的変動によるノイズ

**ノイズ除去のアプローチ：**

- ガウスノイズ → ガウシアンフィルタ、平滑化フィルタ

- スパイクノイズ → メディアンフィルタ

- 量子ノイズ → 適応型フィルタ、ウェーブレット変換


### 6.2 エッジ強調とコントラスト改善

医用画像では、構造の境界（エッジ）が診断において重要な情報を持ちます。エッジ強調処理により、構造の視認性を向上させることができます。

**主なエッジ強調技術：**

- 高域強調フィルタ

- アンシャープマスキング

- ラプラシアン処理

**コントラスト改善技術：**

- ヒストグラム均等化

- ウィンドウレベル調整

- 適応的コントラスト強調

### 6.3 画質改善の臨床例

実際の臨床現場でのフィルタ処理の応用例を紹介します。

**X線画像での応用：**

- 骨構造の強調

- 肺野内の微細構造の視認性向上

- 乳房X線画像（マンモグラフィ）での微小石灰化の検出支援

**CT画像での応用：**

- 金属アーチファクトの低減

- 低線量CTの画質改善

- 肺野内の結節検出支援

**MRI画像での応用：**

- ギブスアーチファクトの低減

- 信号対雑音比の向上

- 拡散強調画像の画質改善
<figure>
  <img src="../img/03-08.png" alt="医用画像のフィルタリング" width="800" height="auto">
  <figcaption>医用画像の質改善</figcaption>
</figure>


---


## 7. まとめ

本講義では画像フィルタリングと画質改善技術について学びました。

**主要なポイント：**

1. **フーリエ変換**は、画像を周波数成分に分解し、周波数領域での分析・処理を可能にする

2. **フィルタ処理**は空間領域（畳み込み）と周波数領域（乗算）の両方で実現できる

3. **代表的なフィルタ**には、低域通過フィルタ（平滑化）、高域通過フィルタ（エッジ強調）、帯域通過/帯域除去フィルタがある

4. **医用画像への応用**として、ノイズ除去、エッジ強調、コントラスト改善などがある

5. **最新技術**として、適応型フィルタリング、マルチスケール解析、深層学習による画像処理がある

これらの技術を適切に活用することで、医用画像の診断精度向上に貢献することができます。


## 第3回 演習
- [Google Form](https://forms.gle/iqDRXu36SzVDy9w4A)

<figure>
  <img src="../img/03-09.png" alt="第3回演習" width="300" height="auto">
  <figcaption>第3回演習</figcaption>
</figure>
