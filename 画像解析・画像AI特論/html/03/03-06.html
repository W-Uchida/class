<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像フィルタリングツール</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            color: #555;
            margin-top: 25px;
        }
        .control-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        .image-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        .image-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #444;
        }
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
        }
        .kernel-grid {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            gap: 2px;
            margin: 15px auto;
            max-width: 160px;
        }
        .kernel-cell {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            background-color: #4CAF50;
            color: white;
        }
        button:hover {
            background-color: #45a049;
        }
        select, input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .info-box {
            margin-top: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 5px solid #2196F3;
        }
        .info-box ul {
            margin-top: 10px;
            padding-left: 20px;
        }
        .info-box li {
            margin-bottom: 8px;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-button {
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
        }
        .custom-kernel {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .custom-kernel input {
            width: 40px;
            text-align: center;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status-message.error {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
            display: block;
        }
        .status-message.success {
            background-color: #e8f5e9;
            color: #388e3c;
            border: 1px solid #c8e6c9;
            display: block;
        }
        .highlight-button {
            background-color: #ff5722;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 87, 34, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0);
            }
        }
        .kernel-info {
            margin-top: 10px;
            font-style: italic;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>画像フィルタリングツール</h1>
        
        <div class="control-panel">
            <div class="file-input-wrapper">
                <div class="file-input-button">画像をアップロード</div>
                <input type="file" id="image-upload" accept="image/*">
            </div>
            
            <div>
                <label for="kernel-type">フィルタータイプ: </label>
                <select id="kernel-type">
                    <option value="identity">恒等フィルター</option>
                    <option value="average" selected>平滑化フィルタ（移動平均）</option>
                    <option value="gaussian">ガウシアンフィルタ</option>
                    <option value="median">メディアンフィルタ</option>
                    <option value="sobelx">Sobel X方向</option>
                    <option value="sobely">Sobel Y方向</option>
                    <option value="laplacian">ラプラシアンフィルタ</option>
                    <option value="custom">カスタム</option>
                </select>
            </div>
            
            <button id="apply-filter" class="highlight-button">フィルタを適用</button>
            <button id="download-image" disabled>処理画像を保存</button>
        </div>
        
        <div id="status-message" class="status-message"></div>
        
        <div id="custom-kernel" class="custom-kernel">
            <h3>カスタムカーネル:</h3>
            <div class="kernel-grid">
                <input type="number" step="0.1" value="0" id="k00">
                <input type="number" step="0.1" value="0" id="k01">
                <input type="number" step="0.1" value="0" id="k02">
                <input type="number" step="0.1" value="0" id="k10">
                <input type="number" step="0.1" value="1" id="k11">
                <input type="number" step="0.1" value="0" id="k12">
                <input type="number" step="0.1" value="0" id="k20">
                <input type="number" step="0.1" value="0" id="k21">
                <input type="number" step="0.1" value="0" id="k22">
            </div>
        </div>
        
        <div class="image-container">
            <div class="image-box">
                <h3>元画像</h3>
                <canvas id="original-canvas"></canvas>
            </div>
            
            <div class="image-box">
                <h3>処理画像</h3>
                <canvas id="result-canvas"></canvas>
            </div>
        </div>
        
        <div class="control-panel">
            <div>
                <label for="kernel-size">カーネルサイズ: </label>
                <select id="kernel-size">
                    <option value="3" selected>3x3</option>
                    <option value="5">5x5</option>
                    <option value="7">7x7</option>
                </select>
            </div>
            
            <div>
                <label for="normalize">値の正規化: </label>
                <input type="checkbox" id="normalize" checked>
            </div>

            <div>
                <label for="grayscale">グレースケール変換: </label>
                <input type="checkbox" id="grayscale">
            </div>
        </div>
        
        <h2>現在のカーネル</h2>
        <div id="kernel-display" class="kernel-grid"></div>
        <div id="kernel-info" class="kernel-info"></div>
        
        <div class="info-box">
            <h2>詳細説明:</h2>
            <ul>
                <li><strong>恒等フィルター</strong>: 元画像をそのまま表示します。</li>
                <li><strong>平滑化フィルタ（移動平均）</strong>: すべての要素が同じ値（1/n²）のカーネルを使用します。画像がぼやけ、ノイズが低減されます。</li>
                <li><strong>ガウシアンフィルタ</strong>: 2次元ガウス関数に基づくフィルタで、中心ほど重みが大きく、周辺ほど小さくなります。自然なぼかし効果があり、エッジを保持しながらノイズを低減します。</li>
                <li><strong>メディアンフィルタ</strong>: 各ピクセルを周囲のピクセル値の中央値で置き換えます。特にソルト＆ペッパーノイズ（白と黒の点状のノイズ）の除去に効果的です。エッジを保存しながらノイズを低減します。</li>
                <li><strong>Sobel X/Y方向</strong>: 画像の勾配（明暗の変化率）を計算し、水平/垂直方向のエッジを強調します。</li>
                <li><strong>ラプラシアンフィルタ</strong>: 画像の2次微分を近似し、エッジを検出します。エッジ部分が強調されます。</li>
                <li><strong>カスタム</strong>: 独自のカーネル値を設定できます。</li>
            </ul>
        </div>
    </div>
    
    <div class="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // 初期設定
        let originalImage = null;
        let kernelSize = 3;
        let isProcessing = false;
        let hasFilterBeenApplied = false;
        
        // カーネルの種類 (3x3)
        const kernels3x3 = {
            identity: [
                [0, 0, 0],
                [0, 1, 0],
                [0, 0, 0]
            ],
            average: [
                [1/9, 1/9, 1/9],
                [1/9, 1/9, 1/9],
                [1/9, 1/9, 1/9]
            ],
            gaussian: [
                [1/16, 2/16, 1/16],
                [2/16, 4/16, 2/16],
                [1/16, 2/16, 1/16]
            ],
            sobelx: [
                [-1, 0, 1],
                [-2, 0, 2],
                [-1, 0, 1]
            ],
            sobely: [
                [-1, -2, -1],
                [0, 0, 0],
                [1, 2, 1]
            ],
            laplacian: [
                [0, 1, 0],
                [1, -4, 1],
                [0, 1, 0]
            ],
            custom: [
                [0, 0, 0],
                [0, 1, 0],
                [0, 0, 0]
            ]
        };
        
        // カーネルの種類 (5x5)
        const kernels5x5 = {
            identity: Array(5).fill().map((_, i) => Array(5).fill(0).map((_, j) => i === 2 && j === 2 ? 1 : 0)),
            average: Array(5).fill().map(() => Array(5).fill(1/25)),
            gaussian: [
                [1/273, 4/273, 7/273, 4/273, 1/273],
                [4/273, 16/273, 26/273, 16/273, 4/273],
                [7/273, 26/273, 41/273, 26/273, 7/273],
                [4/273, 16/273, 26/273, 16/273, 4/273],
                [1/273, 4/273, 7/273, 4/273, 1/273]
            ],
            sobelx: [
                [-2, -1, 0, 1, 2],
                [-2, -1, 0, 1, 2],
                [-4, -2, 0, 2, 4],
                [-2, -1, 0, 1, 2],
                [-2, -1, 0, 1, 2]
            ],
            sobely: [
                [-2, -2, -4, -2, -2],
                [-1, -1, -2, -1, -1],
                [0, 0, 0, 0, 0],
                [1, 1, 2, 1, 1],
                [2, 2, 4, 2, 2]
            ],
            laplacian: [
                [0, 0, 1, 0, 0],
                [0, 1, 2, 1, 0],
                [1, 2, -16, 2, 1],
                [0, 1, 2, 1, 0],
                [0, 0, 1, 0, 0]
            ],
            custom: Array(5).fill().map((_, i) => Array(5).fill(0).map((_, j) => i === 2 && j === 2 ? 1 : 0))
        };
        
        // カーネルの種類 (7x7)
        const kernels7x7 = {
            identity: Array(7).fill().map((_, i) => Array(7).fill(0).map((_, j) => i === 3 && j === 3 ? 1 : 0)),
            average: Array(7).fill().map(() => Array(7).fill(1/49)),
            gaussian: [
                [1/1024, 6/1024, 15/1024, 20/1024, 15/1024, 6/1024, 1/1024],
                [6/1024, 36/1024, 90/1024, 120/1024, 90/1024, 36/1024, 6/1024],
                [15/1024, 90/1024, 225/1024, 300/1024, 225/1024, 90/1024, 15/1024],
                [20/1024, 120/1024, 300/1024, 400/1024, 300/1024, 120/1024, 20/1024],
                [15/1024, 90/1024, 225/1024, 300/1024, 225/1024, 90/1024, 15/1024],
                [6/1024, 36/1024, 90/1024, 120/1024, 90/1024, 36/1024, 6/1024],
                [1/1024, 6/1024, 15/1024, 20/1024, 15/1024, 6/1024, 1/1024]
            ],
            sobelx: [
                [-3, -2, -1, 0, 1, 2, 3],
                [-3, -2, -1, 0, 1, 2, 3],
                [-3, -2, -1, 0, 1, 2, 3],
                [-6, -4, -2, 0, 2, 4, 6],
                [-3, -2, -1, 0, 1, 2, 3],
                [-3, -2, -1, 0, 1, 2, 3],
                [-3, -2, -1, 0, 1, 2, 3]
            ],
            sobely: [
                [-3, -3, -3, -6, -3, -3, -3],
                [-2, -2, -2, -4, -2, -2, -2],
                [-1, -1, -1, -2, -1, -1, -1],
                [0, 0, 0, 0, 0, 0, 0],
                [1, 1, 1, 2, 1, 1, 1],
                [2, 2, 2, 4, 2, 2, 2],
                [3, 3, 3, 6, 3, 3, 3]
            ],
            laplacian: [
                [0, 0, 0, 1, 0, 0, 0],
                [0, 0, 1, 1, 1, 0, 0],
                [0, 1, 1, 2, 1, 1, 0],
                [1, 1, 2, -24, 2, 1, 1],
                [0, 1, 1, 2, 1, 1, 0],
                [0, 0, 1, 1, 1, 0, 0],
                [0, 0, 0, 1, 0, 0, 0]
            ],
            custom: Array(7).fill().map((_, i) => Array(7).fill(0).map((_, j) => i === 3 && j === 3 ? 1 : 0))
        };
        
        // DOM要素の取得
        const originalCanvas = document.getElementById('original-canvas');
        const resultCanvas = document.getElementById('result-canvas');
        const kernelTypeSelect = document.getElementById('kernel-type');
        const kernelSizeSelect = document.getElementById('kernel-size');
        const kernelDisplayEl = document.getElementById('kernel-display');
        const kernelInfoEl = document.getElementById('kernel-info');
        const applyFilterBtn = document.getElementById('apply-filter');
        const downloadBtn = document.getElementById('download-image');
        const imageUpload = document.getElementById('image-upload');
        const normalizeCheckbox = document.getElementById('normalize');
        const grayscaleCheckbox = document.getElementById('grayscale');
        const customKernelDiv = document.getElementById('custom-kernel');
        const loadingEl = document.querySelector('.loading');
        const statusMessageEl = document.getElementById('status-message');
        
        // イベントリスナーの設定
        applyFilterBtn.addEventListener('click', applyFilter);
        downloadBtn.addEventListener('click', downloadImage);
        imageUpload.addEventListener('change', handleImageUpload);
        kernelTypeSelect.addEventListener('change', updateKernel);
        kernelSizeSelect.addEventListener('change', updateKernel);
        
        // カスタムカーネル入力フィールドのイベントリスナー
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                const inputEl = document.getElementById(`k${i}${j}`);
                if (inputEl) {
                    inputEl.addEventListener('change', updateCustomKernel);
                }
            }
        }
        
        // 初期化
        updateKernel();
        
        // ステータスメッセージの表示
        function showStatus(message, isError = false) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = 'status-message ' + (isError ? 'error' : 'success');
            statusMessageEl.style.display = 'block';
            
            // 3秒後に非表示
            setTimeout(() => {
                statusMessageEl.style.display = 'none';
            }, 3000);
        }
        
        // 画像アップロード処理
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // ファイルタイプチェック
            if (!file.type.match('image.*')) {
                showStatus('画像ファイルのみアップロードできます。', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    displayOriginalImage();
                    showStatus('画像を読み込みました。「フィルタを適用」ボタンを押して処理を開始してください。');
                    // フィルタボタンをハイライト
                    applyFilterBtn.classList.add('highlight-button');
                    // 処理画像をクリア
                    clearResultCanvas();
                    hasFilterBeenApplied = false;
                };
                img.onerror = function() {
                    showStatus('画像の読み込みに失敗しました。', true);
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                showStatus('ファイルの読み込みに失敗しました。', true);
            };
            reader.readAsDataURL(file);
        }
        
        // 結果キャンバスをクリア
        function clearResultCanvas() {
            if (resultCanvas) {
                const ctx = resultCanvas.getContext('2d');
                ctx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            }
            downloadBtn.disabled = true;
        }
        
        // 元画像の表示
        function displayOriginalImage() {
            if (!originalImage) return;
            
            try {
                const ctx = originalCanvas.getContext('2d');
                
                // キャンバスのサイズを設定
                const maxWidth = 500;
                const maxHeight = 500;
                let width = originalImage.width;
                let height = originalImage.height;
                
                if (width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = height * ratio;
                }
                
                if (height > maxHeight) {
                    const ratio = maxHeight / height;
                    height = maxHeight;
                    width = width * ratio;
                }
                
                originalCanvas.width = width;
                originalCanvas.height = height;
                resultCanvas.width = width;
                resultCanvas.height = height;
                
                // 画像を描画
                ctx.drawImage(originalImage, 0, 0, width, height);
            } catch (error) {
                console.error('画像表示エラー:', error);
                showStatus('画像の表示に失敗しました: ' + error.message, true);
            }
        }
        
        // カーネルの更新
        function updateKernel() {
            const kernelType = kernelTypeSelect.value;
            kernelSize = parseInt(kernelSizeSelect.value);
            
            // カスタムカーネル入力フィールドの表示/非表示
            if (kernelType === 'custom') {
                customKernelDiv.style.display = 'block';
            } else {
                customKernelDiv.style.display = 'none';
            }
            
            // カーネル表示の更新
            displayKernel();
            
            // フィルタがすでに適用されていた場合はフィルタボタンをハイライト
            if (originalImage) {
                applyFilterBtn.classList.add('highlight-button');
                if (hasFilterBeenApplied) {
                    showStatus('設定が変更されました。「フィルタを適用」ボタンを押して再処理してください。');
                }
            }
        }
        
        // カスタムカーネルの更新
        function updateCustomKernel() {
            // サイズが3x3のカスタムカーネルのみサポート
            if (kernelSize === 3) {
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        const inputEl = document.getElementById(`k${i}${j}`);
                        if (inputEl) {
                            kernels3x3.custom[i][j] = parseFloat(inputEl.value) || 0;
                        }
                    }
                }
            }
            
            displayKernel();
            
            // フィルタがすでに適用されていた場合はフィルタボタンをハイライト
            if (originalImage) {
                applyFilterBtn.classList.add('highlight-button');
                if (hasFilterBeenApplied) {
                    showStatus('カスタムカーネルが変更されました。「フィルタを適用」ボタンを押して再処理してください。');
                }
            }
        }
        
        // カーネルの表示
        function displayKernel() {
            kernelDisplayEl.innerHTML = '';
            kernelInfoEl.textContent = '';
            
            const kernelType = kernelTypeSelect.value;
            
            // メディアンフィルタの場合は特別な表示
            if (kernelType === 'median') {
                kernelDisplayEl.style.display = 'none';
                kernelInfoEl.textContent = 'メディアンフィルタはカーネル係数ではなく、周囲のピクセル値の中央値を計算します。';
                return;
            }
            
            // 通常のカーネル表示
            kernelDisplayEl.style.display = 'grid';
            
            let currentKernel;
            if (kernelSize === 3) {
                currentKernel = kernels3x3[kernelType];
            } else if (kernelSize === 5) {
                currentKernel = kernels5x5[kernelType];
            } else {
                currentKernel = kernels7x7[kernelType];
            }
            
            // カーネルグリッドのスタイル調整
            kernelDisplayEl.style.gridTemplateColumns = `repeat(${kernelSize}, 50px)`;
            
            for (let i = 0; i < kernelSize; i++) {
                for (let j = 0; j < kernelSize; j++) {
                    const kernelCell = document.createElement('div');
                    kernelCell.className = 'kernel-cell';
                    
                    // 数値のフォーマット（小数点以下3桁まで表示）
                    let value = currentKernel[i][j];
                    if (typeof value === 'number') {
                        if (value !== Math.floor(value)) {
                            value = value.toFixed(3);
                        }
                    }
                    
                    kernelCell.textContent = value;
                    kernelDisplayEl.appendChild(kernelCell);
                }
            }
        }
        
        // フィルタの適用
        function applyFilter() {
            if (!originalImage) {
                showStatus('画像が読み込まれていません。画像をアップロードしてください。', true);
                return;
            }
            
            if (isProcessing) return;
            
            isProcessing = true;
            loadingEl.style.display = 'flex';
            
            // フィルタボタンのハイライトを解除
            applyFilterBtn.classList.remove('highlight-button');
            
            // 非同期処理のためにタイムアウトを使用
            setTimeout(() => {
                try {
                    // キャンバスのコンテキスト取得
                    const origCtx = originalCanvas.getContext('2d');
                    const resultCtx = resultCanvas.getContext('2d');
                    
                    // 画像データの取得
                    const imageData = origCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
                    
                    // グレースケール変換
                    let processedImageData = imageData;
                    if (grayscaleCheckbox.checked) {
                        processedImageData = convertToGrayscale(imageData);
                        // グレースケール画像を元画像キャンバスに表示
                        origCtx.putImageData(processedImageData, 0, 0);
                    }
                    
                    // 現在のフィルタタイプと正規化設定を取得
                    const filterType = kernelTypeSelect.value;
                    const shouldNormalize = normalizeCheckbox.checked;
                    
                    let resultData;
                    
                    // メディアンフィルタの場合は特別な処理
                    if (filterType === 'median') {
                        resultData = applyMedianFilter(processedImageData, kernelSize);
                    } else {
                        // 通常のカーネルフィルタ
                        // カーネルの取得
                        let kernel;
                        if (kernelSize === 3) {
                            kernel = kernels3x3[filterType];
                        } else if (kernelSize === 5) {
                            kernel = kernels5x5[filterType];
                        } else {
                            kernel = kernels7x7[filterType];
                        }
                        
                        // 畳み込み処理の実行
                        resultData = applyConvolution(processedImageData, kernel, shouldNormalize);
                    }
                    
                    // 結果の表示
                    resultCtx.putImageData(resultData, 0, 0);
                    
                    // ダウンロードボタンを有効化
                    downloadBtn.disabled = false;
                    
                    // フィルタが適用されたことを記録
                    hasFilterBeenApplied = true;
                    
                    showStatus('フィルタを適用しました。');
                } catch (error) {
                    console.error('フィルタ適用エラー:', error);
                    showStatus('フィルタの適用に失敗しました: ' + error.message, true);
                }
                
                isProcessing = false;
                loadingEl.style.display = 'none';
            }, 100);
        }
        
        // グレースケール変換
        function convertToGrayscale(imageData) {
            const data = imageData.data;
            const result = new ImageData(imageData.width, imageData.height);
            const resultData = result.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const avg = Math.round((data[i] + data[i + 1] + data[i + 2]) / 3);
                resultData[i] = avg;     // R
                resultData[i + 1] = avg; // G
                resultData[i + 2] = avg; // B
                resultData[i + 3] = data[i + 3]; // アルファ値はそのまま
            }
            
            return result;
        }
        
        // メディアンフィルタの適用
        function applyMedianFilter(imageData, size) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const result = new ImageData(width, height);
            const resultData = result.data;
            
            // カーネルの中心を計算
            const radius = Math.floor(size / 2);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    // 各チャンネルの値を格納する配列
                    const valuesR = [];
                    const valuesG = [];
                    const valuesB = [];
                    
                    // 周囲のピクセル値を収集
                    for (let ky = -radius; ky <= radius; ky++) {
                        for (let kx = -radius; kx <= radius; kx++) {
                            // 対応するピクセル座標
                            const pixelX = Math.min(Math.max(x + kx, 0), width - 1);
                            const pixelY = Math.min(Math.max(y + ky, 0), height - 1);
                            
                            // ピクセルのインデックス
                            const pixelIndex = (pixelY * width + pixelX) * 4;
                            
                            // 値を配列に追加
                            valuesR.push(data[pixelIndex]);
                            valuesG.push(data[pixelIndex + 1]);
                            valuesB.push(data[pixelIndex + 2]);
                        }
                    }
                    
                    // 各チャンネルの中央値を計算
                    const medianR = getMedian(valuesR);
                    const medianG = getMedian(valuesG);
                    const medianB = getMedian(valuesB);
                    
                    // 結果のインデックス
                    const resultIndex = (y * width + x) * 4;
                    
                    // 結果の設定
                    resultData[resultIndex] = medianR;
                    resultData[resultIndex + 1] = medianG;
                    resultData[resultIndex + 2] = medianB;
                    resultData[resultIndex + 3] = data[(y * width + x) * 4 + 3]; // アルファ値はそのまま
                }
            }
            
            return result;
        }
        
        // 中央値を計算する関数
        function getMedian(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            
            if (sorted.length % 2 === 0) {
                return Math.round((sorted[mid - 1] + sorted[mid]) / 2);
            } else {
                return sorted[mid];
            }
        }
        
        // 畳み込み処理
        function applyConvolution(imageData, kernel, normalize) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const result = new ImageData(width, height);
            const resultData = result.data;
            
            // カーネルの中心を計算
            const kernelSize = kernel.length;
            const kernelRadius = Math.floor(kernelSize / 2);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let sumR = 0, sumG = 0, sumB = 0;
                    
                    // カーネルの畳み込み計算
                    for (let ky = 0; ky < kernelSize; ky++) {
                        for (let kx = 0; kx < kernelSize; kx++) {
                            // 対応するピクセル座標
                            const pixelX = Math.min(Math.max(x + kx - kernelRadius, 0), width - 1);
                            const pixelY = Math.min(Math.max(y + ky - kernelRadius, 0), height - 1);
                            
                            // ピクセルのインデックス
                            const pixelIndex = (pixelY * width + pixelX) * 4;
                            
                            // カーネル値
                            const kernelValue = kernel[ky][kx];
                            
                            // 値を加算
                            sumR += data[pixelIndex] * kernelValue;
                            sumG += data[pixelIndex + 1] * kernelValue;
                            sumB += data[pixelIndex + 2] * kernelValue;
                        }
                    }
                    
                    // 結果のインデックス
                    const resultIndex = (y * width + x) * 4;
                    
                    // 値の正規化（必要な場合）
                    if (normalize) {
                        sumR = Math.min(255, Math.max(0, Math.round(sumR)));
                        sumG = Math.min(255, Math.max(0, Math.round(sumG)));
                        sumB = Math.min(255, Math.max(0, Math.round(sumB)));
                    }
                    
                    // 結果の設定
                    resultData[resultIndex] = sumR;
                    resultData[resultIndex + 1] = sumG;
                    resultData[resultIndex + 2] = sumB;
                    resultData[resultIndex + 3] = data[(y * width + x) * 4 + 3]; // アルファ値はそのまま
                }
            }
            
            return result;
        }
        
        // 処理画像のダウンロード
        function downloadImage() {
            if (!resultCanvas) return;
            
            try {
                const link = document.createElement('a');
                link.download = 'filtered-image.png';
                link.href = resultCanvas.toDataURL('image/png');
                link.click();
                showStatus('画像を保存しました。');
            } catch (error) {
                console.error('ダウンロードエラー:', error);
                showStatus('画像の保存に失敗しました: ' + error.message, true);
            }
        }
        
        // デフォルト画像の読み込み試行
        window.addEventListener('load', function() {
            // 'a.jpeg'を読み込む（同じディレクトリにある場合）
            try {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    displayOriginalImage();
                    showStatus('デフォルト画像を読み込みました。「フィルタを適用」ボタンを押して処理を開始してください。');
                    // フィルタボタンをハイライト
                    applyFilterBtn.classList.add('highlight-button');
                };
                img.onerror = function(error) {
                    console.warn('デフォルト画像の読み込みに失敗しました:', error);
                    showStatus('デフォルト画像を読み込めませんでした。画像をアップロードしてください。', true);
                };
                img.src = 'Lung_CT.jpg';
            } catch (error) {
                console.warn('デフォルト画像の読み込みに失敗しました:', error);
                showStatus('デフォルト画像を読み込めませんでした。画像をアップロードしてください。', true);
            }
        });
    </script>
</body>
</html>